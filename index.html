<html>

<head>
    <style>
        .canvas {
            height: 600px;
        }

        #epot {
            position: absolute;
            border: 1px solid black;
        }

        #efield {
            position: absolute;
            border: 1px solid black;
        }

        .slidecontainer {
            float: left;
            width: 100%;
            /* Width of the outside container */
        }
    </style>
</head>

<body>
    <div class="canvas">
        <canvas id='epot' width='1200' height='600'></canvas>
        <canvas id='efield' width='1200' height='600'></canvas>
    </div>
    <div class='slidecontainer'>
        <span>Number of particles:</span>
        <input type="range" min="1" max="10000" step="1" value="30" class="slider" id="countSlider" />
        <span id='countValue'></span>
    </div>
    <div>
        <button id="startButton">Draw</button>
    </div>
    <div>
        <div id='progressBar'></div>
    </div>
</body>

<script>
    let charges = count => {
        // return [{
        //         x: 400,
        //         y: HEIGHT/2,
        //         q: 10
        //     },{
        //         x: 800,
        //         y: HEIGHT/2,
        //         q: -5
        //     }
        //     ];

        let charges = [];
        for (charge = 0; charge < count; charge++) {
            charges.push({
                x: Math.floor(Math.random() * WIDTH),
                y: Math.floor(Math.random() * HEIGHT),
                q: Math.random() * 20 - 10
            })
        }
        return charges;
    };

    let sleep = ms => (new Promise(resolve => (setTimeout(resolve, ms))))
    let epot = document.getElementById('epot');
    let efield = document.getElementById('efield');
    let epotCtx = epot.getContext('2d');
    let efieldCtx = efield.getContext('2d');
    let countSlider = document.getElementById('countSlider');
    let countValue = document.getElementById('countValue');
    let startButton = document.getElementById('startButton');
    let progressBar = document.getElementById('progressBar');
    let progress = (message) => {
        progressBar.innerHTML = message
    };
    countValue.innerHTML = countSlider.value;
    const HEIGHT = epot.height;
    const WIDTH = epot.width;

    let opts = {
        epot: epotCtx,
        efield: efieldCtx,
        gridSteps: 50,
        HEIGHT,
        WIDTH,
        charges: charges(countSlider.value)
    }

    countSlider.oninput = function () {
        countValue.innerHTML = this.value;
    }


    startButton.onclick = async function () {
        opts.charges = charges(countSlider.value);
        render(opts, progress);
    }

    render(opts, progress).then(() => {
        console.log('Done');
    });


    async function render(opts, onProgress) {
        onProgress("Computing...");
        await sleep(0);
        let { gridSteps, epot, efield, HEIGHT, WIDTH, charges } = opts;
        let total = HEIGHT * WIDTH * charges.length;
        let count = 0;
        let vMax = Number.NEGATIVE_INFINITY;
        let vMin = Number.POSITIVE_INFINITY;
        let plot = [];
        for (let x = 0; x < WIDTH; x++) {
            onProgress(`${(100 * (x + 1) / WIDTH).toFixed(0)}%`);
            await sleep(0);
            plot.push([]);
            for (charge of charges) charge.dx = (x - charge.x) * (x - charge.x);
            for (let y = 0; y < HEIGHT; y++) {
                let v = 0;
                for (charge of charges) {
                    charge.dy = (y - charge.y) * (y - charge.y);
                    charge.dist = Math.sqrt(charge.dx + charge.dy);
                    v += (charge.dist ? charge.q / charge.dist : 0);
                }
                if (v > vMax) vMax = v;
                if (v < vMin) vMin = v;
                plot[x][y] = v;
            }
        }

        // efield.clearRect(0, 0, WIDTH, HEIGHT);
        // efield.fillStyle = '#000000';
        // for (let x = 0; x < WIDTH; x += gridSteps) {
        //     for (let y = 0; y < HEIGHT; y += gridSteps) {
        //         efield.fillRect(x, y, 10, 10);
        //     }
        // }


        epot.clearRect(0, 0, WIDTH, HEIGHT);
        let range = vMax - vMin;
        let mag = Math.max(Math.abs(vMax),Math.abs(vMin));
        for (let x = 0; x < WIDTH; x++) {
            for (let y = 0; y < HEIGHT; y++) {
                let v = plot[x][y];
                let color = { r: 0, g: 0, b: 0 }
                let percent = range?Math.abs(v/range):0;
                let alpha = percent*50;
                if (v > 0) color.r = 255;
                else color.b = 255;
                epot.fillStyle = `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha})`;
                epot.fillRect(x, y, 1, 1);
            }
            await sleep(0);
        }
    }

</script>

</html>